{"version":3,"file":"ice.js","sourceRoot":"","sources":["../../../../ice/src/ice.ts"],"names":[],"mappings":"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","sourcesContent":["import { randomBytes } from \"crypto\";\nimport debug from \"debug\";\nimport { Uint64BE } from \"int64-buffer\";\nimport * as nodeIp from \"ip\";\nimport isEqual from \"lodash/isEqual\";\nimport range from \"lodash/range\";\nimport { isIPv4 } from \"net\";\nimport os from \"os\";\nimport PCancelable from \"p-cancelable\";\nimport { Event } from \"rx.mini\";\nimport timers from \"timers/promises\";\n\nimport { InterfaceAddresses } from \"../../common/src/network\";\nimport { Candidate, candidateFoundation, candidatePriority } from \"./candidate\";\nimport { DnsLookup } from \"./dns/lookup\";\nimport { TransactionError } from \"./exceptions\";\nimport { difference, Future, future, PQueue, randomString } from \"./helper\";\nimport { classes, methods } from \"./stun/const\";\nimport { Message, parseMessage } from \"./stun/message\";\nimport { StunProtocol } from \"./stun/protocol\";\nimport { createTurnEndpoint } from \"./turn/protocol\";\nimport { Address, Protocol } from \"./types/model\";\nimport { normalizeFamilyNodeV18 } from \"./utils\";\n\nconst log = debug(\"werift-ice : packages/ice/src/ice.ts : log\");\n\nexport class Connection {\n  localUserName = randomString(4);\n  localPassword = randomString(22);\n  remotePassword: string = \"\";\n  remoteUsername: string = \"\";\n  remoteIsLite = false;\n  checkList: CandidatePair[] = [];\n  localCandidates: Candidate[] = [];\n  stunServer?: Address;\n  turnServer?: Address;\n  useIpv4: boolean;\n  useIpv6: boolean;\n  options: IceOptions;\n  remoteCandidatesEnd = false;\n  /**コンポーネントはデータストリームの一部です. データストリームには複数のコンポーネントが必要な場合があり、\n   * データストリーム全体が機能するには、それぞれが機能する必要があります.\n   *  RTP / RTCPデータストリームの場合、RTPとRTCPが同じポートで多重化されていない限り、データストリームごとに2つのコンポーネントがあります.\n   * 1つはRTP用、もう1つはRTCP用です. コンポーネントには候補ペアがあり、他のコンポーネントでは使用できません.  */\n  _components: Set<number>;\n  _localCandidatesEnd = false;\n  _tieBreaker: BigInt = BigInt(new Uint64BE(randomBytes(64)).toString());\n  state: IceState = \"new\";\n  dnsLookup?: DnsLookup;\n\n  readonly onData = new Event<[Buffer, number]>();\n  readonly stateChanged = new Event<[IceState]>();\n\n  private _remoteCandidates: Candidate[] = [];\n  // P2P接続完了したソケット\n  private nominated: { [componentId: number]: CandidatePair } = {};\n  get nominatedKeys() {\n    return Object.keys(this.nominated).map((v) => v.toString());\n  }\n  private nominating = new Set<number>();\n  private checkListDone = false;\n  private checkListState = new PQueue<number>();\n  private earlyChecks: [Message, Address, Protocol][] = [];\n  private localCandidatesStart = false;\n  private protocols: Protocol[] = [];\n  private queryConsentHandle?: Future;\n  private promiseGatherCandidates?: Event<[]>;\n\n  constructor(public iceControlling: boolean, options?: Partial<IceOptions>) {\n    this.options = {\n      ...defaultOptions,\n      ...options,\n    };\n    const { components, stunServer, turnServer, useIpv4, useIpv6 } =\n      this.options;\n    this.stunServer = validateAddress(stunServer);\n    this.turnServer = validateAddress(turnServer);\n    this.useIpv4 = useIpv4;\n    this.useIpv6 = useIpv6;\n    this._components = new Set(range(1, components + 1));\n  }\n\n  setRemoteParams({\n    iceLite,\n    usernameFragment,\n    password,\n  }: {\n    iceLite: boolean;\n    usernameFragment: string;\n    password: string;\n  }) {\n    log(\"setRemoteParams\", { iceLite, usernameFragment, password });\n    this.remoteIsLite = iceLite;\n    this.remoteUsername = usernameFragment;\n    this.remotePassword = password;\n  }\n\n  // 4.1.1 Gathering Candidates\n  async gatherCandidates(cb?: (candidate: Candidate) => void) {\n    if (!this.localCandidatesStart) {\n      this.localCandidatesStart = true;\n      this.promiseGatherCandidates = new Event();\n\n      let address = getHostAddresses(this.useIpv4, this.useIpv6);\n      const { interfaceAddresses } = this.options;\n      if (interfaceAddresses) {\n        const filteredAddresses = address.filter((check) =>\n          Object.values(interfaceAddresses).includes(check)\n        );\n        if (filteredAddresses.length) {\n          address = filteredAddresses;\n        }\n      }\n      if (this.options.additionalHostAddresses) {\n        address = Array.from(\n          new Set([...this.options.additionalHostAddresses, ...address])\n        );\n      }\n\n      for (const component of this._components) {\n        const candidates = await this.getComponentCandidates(\n          component,\n          address,\n          5,\n          cb\n        );\n        this.localCandidates = [...this.localCandidates, ...candidates];\n      }\n\n      this._localCandidatesEnd = true;\n      this.promiseGatherCandidates.execute();\n    }\n    this.setState(\"completed\");\n  }\n\n  private async getComponentCandidates(\n    component: number,\n    addresses: string[],\n    timeout = 5,\n    cb?: (candidate: Candidate) => void\n  ) {\n    let candidates: Candidate[] = [];\n\n    await Promise.all(\n      addresses.map(async (address) => {\n        // # create transport\n        const protocol = new StunProtocol(this);\n        try {\n          await protocol.connectionMade(\n            isIPv4(address),\n            this.options.portRange,\n            this.options.interfaceAddresses\n          );\n        } catch (error) {\n          log(\"protocol STUN\", error);\n          return;\n        }\n\n        protocol.localAddress = address;\n        this.protocols.push(protocol);\n\n        // # add host candidate\n        const candidateAddress: Address = [address, protocol.getExtraInfo()[1]];\n\n        protocol.localCandidate = new Candidate(\n          candidateFoundation(\"host\", \"udp\", candidateAddress[0]),\n          component,\n          \"udp\",\n          candidatePriority(component, \"host\"),\n          candidateAddress[0],\n          candidateAddress[1],\n          \"host\"\n        );\n\n        candidates.push(protocol.localCandidate);\n        if (cb) {\n          cb(protocol.localCandidate);\n        }\n      })\n    );\n\n    let candidatePromises: Promise<Candidate | void>[] = [];\n\n    // # query STUN server for server-reflexive candidates (IPv4 only)\n    const { stunServer, turnServer } = this;\n    if (stunServer) {\n      const stunPromises = this.protocols.map((protocol) =>\n        new Promise<Candidate | void>(async (r, f) => {\n          const timer = setTimeout(f, timeout * 1000);\n          if (\n            protocol.localCandidate?.host &&\n            isIPv4(protocol.localCandidate?.host)\n          ) {\n            const candidate = await serverReflexiveCandidate(\n              protocol,\n              stunServer\n            ).catch((error) => log(\"error\", error));\n            if (candidate && cb) cb(candidate);\n\n            clearTimeout(timer);\n            r(candidate);\n          } else {\n            clearTimeout(timer);\n            r();\n          }\n        }).catch((error) => {\n          log(\"query STUN server\", error);\n        })\n      );\n      candidatePromises.push(...stunPromises);\n    }\n\n    const { turnUsername, turnPassword } = this.options;\n    if (turnServer && turnUsername && turnPassword) {\n      const turnCandidate = (async () => {\n        const protocol = await createTurnEndpoint(\n          turnServer,\n          turnUsername,\n          turnPassword,\n          {\n            portRange: this.options.portRange,\n            interfaceAddresses: this.options.interfaceAddresses,\n          }\n        );\n        this.protocols.push(protocol);\n\n        const candidateAddress = protocol.turn.relayedAddress;\n        const relatedAddress = protocol.turn.mappedAddress;\n\n        log(\"turn candidateAddress\", candidateAddress);\n\n        protocol.localCandidate = new Candidate(\n          candidateFoundation(\"relay\", \"udp\", candidateAddress[0]),\n          component,\n          \"udp\",\n          candidatePriority(component, \"relay\"),\n          candidateAddress[0],\n          candidateAddress[1],\n          \"relay\",\n          relatedAddress[0],\n          relatedAddress[1]\n        );\n        if (cb) {\n          cb(protocol.localCandidate);\n        }\n        protocol.receiver = this;\n        return protocol.localCandidate;\n      })().catch((error) => {\n        log(\"query TURN server\", error);\n      });\n\n      if (this.options.forceTurn) {\n        candidates = [];\n        candidatePromises = [];\n      }\n\n      candidatePromises.push(turnCandidate);\n    }\n\n    const extraCandidates = (await Promise.all(candidatePromises)).filter(\n      (v): v is Candidate => typeof v !== \"undefined\"\n    );\n\n    candidates.push(...extraCandidates);\n\n    return candidates;\n  }\n\n  async connect() {\n    // \"\"\"\n    // Perform ICE handshake.\n    //\n    // This coroutine returns if a candidate pair was successfully nominated\n    // and raises an exception otherwise.\n    // \"\"\"\n    log(\"start connect ice\", this.localCandidates);\n    if (!this._localCandidatesEnd) {\n      if (!this.localCandidatesStart)\n        throw new Error(\"Local candidates gathering was not performed\");\n      if (this.promiseGatherCandidates)\n        // wait for GatherCandidates finish\n        await this.promiseGatherCandidates.asPromise();\n    }\n    if (!this.remoteUsername || !this.remotePassword)\n      throw new Error(\"Remote username or password is missing\");\n\n    // # 5.7.1. Forming Candidate Pairs\n    this.remoteCandidates.forEach(this.pairRemoteCandidate);\n    this.sortCheckList();\n\n    this.unfreezeInitial();\n\n    // # handle early checks\n    this.earlyChecks.forEach((earlyCheck) => this.checkIncoming(...earlyCheck));\n    this.earlyChecks = [];\n\n    // # perform checks\n    // 5.8.  Scheduling Checks\n    for (;;) {\n      if (this.state === \"closed\") break;\n      if (!this.schedulingChecks()) break;\n      await timers.setTimeout(20);\n    }\n\n    // # wait for completion\n    let res: number = ICE_FAILED;\n    while (this.checkList.length > 0 && res === ICE_FAILED) {\n      res = await this.checkListState.get();\n    }\n\n    // # cancel remaining checks\n    this.checkList.forEach((check) => check.handle?.cancel());\n\n    if (res !== ICE_COMPLETED) {\n      throw new Error(\"ICE negotiation failed\");\n    }\n\n    // # start consent freshness tests\n    this.queryConsentHandle = future(this.queryConsent());\n\n    this.setState(\"connected\");\n  }\n\n  private unfreezeInitial() {\n    // # unfreeze first pair for the first component\n    const firstPair = this.checkList.find(\n      (pair) => pair.component === Math.min(...[...this._components])\n    );\n    if (!firstPair) return;\n    if (firstPair.state === CandidatePairState.FROZEN) {\n      this.setPairState(firstPair, CandidatePairState.WAITING);\n    }\n\n    // # unfreeze pairs with same component but different foundations\n    const seenFoundations = new Set(firstPair.localCandidate.foundation);\n    for (const pair of this.checkList) {\n      if (\n        pair.component === firstPair.component &&\n        !seenFoundations.has(pair.localCandidate.foundation) &&\n        pair.state === CandidatePairState.FROZEN\n      ) {\n        this.setPairState(pair, CandidatePairState.WAITING);\n        seenFoundations.add(pair.localCandidate.foundation);\n      }\n    }\n  }\n\n  // 5.8 Scheduling Checks\n  private schedulingChecks() {\n    // Ordinary Check\n    {\n      // # find the highest-priority pair that is in the waiting state\n      const pair = this.checkList\n        .filter((pair) => {\n          if (this.options.forceTurn && pair.protocol.type === \"stun\")\n            return false;\n          return true;\n        })\n        .find((pair) => pair.state === CandidatePairState.WAITING);\n      if (pair) {\n        pair.handle = future(this.checkStart(pair));\n        return true;\n      }\n    }\n\n    {\n      // # find the highest-priority pair that is in the frozen state\n      const pair = this.checkList.find(\n        (pair) => pair.state === CandidatePairState.FROZEN\n      );\n      if (pair) {\n        pair.handle = future(this.checkStart(pair));\n        return true;\n      }\n    }\n\n    // # if we expect more candidates, keep going\n    if (!this.remoteCandidatesEnd) {\n      return !this.checkListDone;\n    }\n\n    return false;\n  }\n\n  // 4.1.1.4 ? 生存確認 life check\n  private queryConsent = () =>\n    new PCancelable(async (r, f, onCancel) => {\n      let failures = 0;\n\n      const cancelEvent = new AbortController();\n      onCancel(() => {\n        failures += CONSENT_FAILURES;\n        cancelEvent.abort();\n        f(\"cancel\");\n      });\n\n      // \"\"\"\n      // Periodically check consent (RFC 7675).\n      // \"\"\"\n\n      try {\n        while (!this.remoteIsLite && this.state !== \"closed\") {\n          // # randomize between 0.8 and 1.2 times CONSENT_INTERVAL\n          await timers.setTimeout(\n            CONSENT_INTERVAL * (0.8 + 0.4 * Math.random()) * 1000,\n            undefined,\n            { signal: cancelEvent.signal }\n          );\n\n          for (const key of this.nominatedKeys) {\n            const pair = this.nominated[Number(key)];\n            const request = this.buildRequest(pair, false);\n            try {\n              const [msg, addr] = await pair.protocol.request(\n                request,\n                pair.remoteAddr,\n                Buffer.from(this.remotePassword, \"utf8\"),\n                0\n              );\n              failures = 0;\n              if (this.state === \"disconnected\") {\n                this.setState(\"connected\");\n              }\n            } catch (error) {\n              log(\"no stun response\");\n              failures++;\n              this.setState(\"disconnected\");\n            }\n            if (failures >= CONSENT_FAILURES) {\n              log(\"Consent to send expired\");\n              this.queryConsentHandle = undefined;\n              // 切断検知\n              r(await this.close());\n              return;\n            }\n          }\n        }\n      } catch (error) {}\n    });\n\n  async close() {\n    // \"\"\"\n    // Close the connection.\n    // \"\"\"\n\n    this.setState(\"closed\");\n\n    // # stop consent freshness tests\n    if (this.queryConsentHandle && !this.queryConsentHandle.done()) {\n      this.queryConsentHandle.cancel();\n      try {\n        await this.queryConsentHandle.promise;\n      } catch (error) {\n        // pass\n      }\n    }\n\n    // # stop check list\n    if (this.checkList && !this.checkListDone) {\n      this.checkListState.put(\n        new Promise((r) => {\n          r(ICE_FAILED);\n        })\n      );\n    }\n\n    this.nominated = {};\n    for (const protocol of this.protocols) {\n      if (protocol.close) {\n        await protocol.close();\n      }\n    }\n\n    this.protocols = [];\n    this.localCandidates = [];\n\n    await this.dnsLookup?.close();\n  }\n\n  private setState(state: IceState) {\n    this.state = state;\n    this.stateChanged.execute(state);\n  }\n\n  async addRemoteCandidate(remoteCandidate: Candidate | undefined) {\n    // \"\"\"\n    // Add a remote candidate or signal end-of-candidates.\n\n    // To signal end-of-candidates, pass `None`.\n\n    // :param remote_candidate: A :class:`Candidate` instance or `None`.\n    // \"\"\"\n\n    if (!remoteCandidate) {\n      this.pruneComponents();\n      this.remoteCandidatesEnd = true;\n      return;\n    }\n\n    if (remoteCandidate.host.includes(\".local\")) {\n      try {\n        if (this.state === \"closed\") return;\n        if (!this.dnsLookup) {\n          this.dnsLookup = new DnsLookup();\n        }\n        const host = await this.dnsLookup.lookup(remoteCandidate.host);\n        remoteCandidate.host = host;\n      } catch (error) {\n        return;\n      }\n    }\n\n    try {\n      validateRemoteCandidate(remoteCandidate);\n    } catch (error) {\n      return;\n    }\n\n    log(\"addRemoteCandidate\", remoteCandidate);\n    this.remoteCandidates.push(remoteCandidate);\n\n    this.pairRemoteCandidate(remoteCandidate);\n    this.sortCheckList();\n  }\n\n  send = async (data: Buffer) => {\n    // \"\"\"\n    // Send a datagram on the first component.\n\n    // If the connection is not established, a `ConnectionError` is raised.\n\n    // :param data: The data to be sent.\n    // \"\"\"\n    await this.sendTo(data, 1);\n  };\n\n  private async sendTo(data: Buffer, component: number) {\n    // \"\"\"\n    // Send a datagram on the specified component.\n\n    // If the connection is not established, a `ConnectionError` is raised.\n\n    // :param data: The data to be sent.\n    // :param component: The component on which to send the data.\n    // \"\"\"\n    const activePair = this.nominated[component];\n    if (activePair) {\n      await activePair.protocol.sendData(data, activePair.remoteAddr);\n    } else {\n      // log(\"Cannot send data, ice not connected\");\n      return;\n    }\n  }\n\n  getDefaultCandidate(component: number) {\n    const candidates = this.localCandidates.sort(\n      (a, b) => a.priority - b.priority\n    );\n    const candidate = candidates.find(\n      (candidate) => candidate.component === component\n    );\n    return candidate;\n  }\n\n  requestReceived(\n    message: Message,\n    addr: Address,\n    protocol: Protocol,\n    rawData: Buffer\n  ) {\n    if (message.messageMethod !== methods.BINDING) {\n      this.respondError(message, addr, protocol, [400, \"Bad Request\"]);\n      return;\n    }\n\n    // # authenticate request\n    try {\n      parseMessage(rawData, Buffer.from(this.localPassword, \"utf8\"));\n      if (!this.remoteUsername) {\n        const rxUsername = `${this.localUserName}:${this.remoteUsername}`;\n        if (message.getAttributeValue(\"USERNAME\") != rxUsername) {\n          throw new Error(\"Wrong username\");\n        }\n      }\n    } catch (error) {\n      this.respondError(message, addr, protocol, [400, \"Bad Request\"]);\n      return;\n    }\n\n    const { iceControlling } = this;\n\n    // 7.2.1.1.  Detecting and Repairing Role Conflicts\n    if (iceControlling && message.attributesKeys.includes(\"ICE-CONTROLLING\")) {\n      if (this._tieBreaker >= message.getAttributeValue(\"ICE-CONTROLLING\")) {\n        this.respondError(message, addr, protocol, [487, \"Role Conflict\"]);\n        return;\n      } else {\n        this.switchRole(false);\n      }\n    } else if (\n      !iceControlling &&\n      message.attributesKeys.includes(\"ICE-CONTROLLED\")\n    ) {\n      if (this._tieBreaker < message.getAttributeValue(\"ICE-CONTROLLED\")) {\n        this.respondError(message, addr, protocol, [487, \"Role Conflict\"]);\n      } else {\n        this.switchRole(true);\n        return;\n      }\n    }\n\n    if (\n      this.options.filterStunResponse &&\n      !this.options.filterStunResponse(message, addr, protocol)\n    ) {\n      return;\n    }\n\n    // # send binding response\n    const response = new Message(\n      methods.BINDING,\n      classes.RESPONSE,\n      message.transactionId\n    );\n    response\n      .setAttribute(\"XOR-MAPPED-ADDRESS\", addr)\n      .addMessageIntegrity(Buffer.from(this.localPassword, \"utf8\"))\n      .addFingerprint();\n    protocol.sendStun(response, addr);\n\n    // todo fix\n    // if (this.checkList.length === 0) {\n    //   this.earlyChecks.push([message, addr, protocol]);\n    // } else {\n    this.checkIncoming(message, addr, protocol);\n    // }\n  }\n\n  dataReceived(data: Buffer, component: number) {\n    try {\n      this.onData.execute(data, component);\n    } catch (error) {\n      log(\"dataReceived\", error);\n    }\n  }\n\n  // for test only\n  set remoteCandidates(value: Candidate[]) {\n    if (this.remoteCandidatesEnd)\n      throw new Error(\"Cannot set remote candidates after end-of-candidates.\");\n    this._remoteCandidates = [];\n    for (const remoteCandidate of value) {\n      try {\n        validateRemoteCandidate(remoteCandidate);\n      } catch (error) {\n        continue;\n      }\n      this.remoteCandidates.push(remoteCandidate);\n    }\n    this.pruneComponents();\n    this.remoteCandidatesEnd = true;\n  }\n  get remoteCandidates() {\n    return this._remoteCandidates;\n  }\n\n  private pruneComponents() {\n    const seenComponents = new Set(\n      this.remoteCandidates.map((v) => v.component)\n    );\n    const missingComponents = [...difference(this._components, seenComponents)];\n    if (missingComponents.length > 0) {\n      this._components = seenComponents;\n    }\n  }\n\n  private sortCheckList() {\n    sortCandidatePairs(this.checkList, this.iceControlling);\n  }\n\n  private findPair(protocol: Protocol, remoteCandidate: Candidate) {\n    const pair = this.checkList.find(\n      (pair) =>\n        isEqual(pair.protocol, protocol) &&\n        isEqual(pair.remoteCandidate, remoteCandidate)\n    );\n    return pair;\n  }\n\n  private setPairState(pair: CandidatePair, state: CandidatePairState) {\n    log(\"setPairState\", pair.toJSON(), CandidatePairState[state]);\n    pair.updateState(state);\n  }\n\n  private switchRole(iceControlling: boolean) {\n    log(\"switch role\", iceControlling);\n    this.iceControlling = iceControlling;\n    this.sortCheckList();\n  }\n\n  resetNominatedPair() {\n    log(\"resetNominatedPair\");\n    this.nominated = {};\n    this.nominating.clear();\n  }\n\n  private checkComplete(pair: CandidatePair) {\n    pair.handle = undefined;\n    if (pair.state === CandidatePairState.SUCCEEDED) {\n      // Updating the Nominated Flag\n\n      // https://www.rfc-editor.org/rfc/rfc8445#section-7.3.1.5,\n      // Once the nominated flag is set for a component of a data stream, it\n      // concludes the ICE processing for that component.  See Section 8.\n      // So disallow overwriting of the pair nominated for that component\n      if (pair.nominated && this.nominated[pair.component] == undefined) {\n        log(\"nominated\", pair.toJSON());\n        this.nominated[pair.component] = pair;\n        this.nominating.delete(pair.component);\n\n        // 8.1.2.  Updating States\n\n        // The agent MUST remove all Waiting and Frozen pairs in the check\n        // list and triggered check queue for the same component as the\n        // nominated pairs for that media stream.\n        for (const p of this.checkList) {\n          if (\n            p.component === pair.component &&\n            [CandidatePairState.WAITING, CandidatePairState.FROZEN].includes(\n              p.state\n            )\n          ) {\n            this.setPairState(p, CandidatePairState.FAILED);\n          }\n        }\n      }\n\n      // Once there is at least one nominated pair in the valid list for\n      // every component of at least one media stream and the state of the\n      // check list is Running:\n      if (this.nominatedKeys.length === this._components.size) {\n        if (!this.checkListDone) {\n          log(\"ICE completed\");\n          this.checkListState.put(new Promise((r) => r(ICE_COMPLETED)));\n          this.checkListDone = true;\n        }\n        return;\n      }\n\n      // 7.1.3.2.3.  Updating Pair States\n      for (const p of this.checkList) {\n        if (\n          p.localCandidate.foundation === pair.localCandidate.foundation &&\n          p.state === CandidatePairState.FROZEN\n        ) {\n          this.setPairState(p, CandidatePairState.WAITING);\n        }\n      }\n    }\n\n    {\n      const list = [CandidatePairState.SUCCEEDED, CandidatePairState.FAILED];\n      if (this.checkList.find(({ state }) => !list.includes(state))) {\n        return;\n      }\n    }\n\n    if (!this.iceControlling) {\n      const target = CandidatePairState.SUCCEEDED;\n      if (this.checkList.find(({ state }) => state === target)) {\n        return;\n      }\n    }\n\n    if (!this.checkListDone) {\n      log(\"ICE failed\");\n      this.checkListState.put(\n        new Promise((r) => {\n          r(ICE_FAILED);\n        })\n      );\n    }\n  }\n\n  // 3.  Terminology : Check\n  checkStart = (pair: CandidatePair) =>\n    new PCancelable(async (r, f, onCancel) => {\n      onCancel(() => f(\"cancel\"));\n\n      // \"\"\"\n      // Starts a check.\n      // \"\"\"\n\n      log(\"check start\", pair.toJSON());\n\n      this.setPairState(pair, CandidatePairState.IN_PROGRESS);\n\n      const nominate = this.iceControlling && !this.remoteIsLite;\n      const request = this.buildRequest(pair, nominate);\n\n      const result: { response?: Message; addr?: Address } = {};\n      try {\n        const [response, addr] = await pair.protocol.request(\n          request,\n          pair.remoteAddr,\n          Buffer.from(this.remotePassword, \"utf8\"),\n          4\n        );\n        log(\"response\", response, addr);\n        result.response = response;\n        result.addr = addr;\n      } catch (error: any) {\n        const exc: TransactionError = error;\n        // 7.1.3.1.  Failure Cases\n        log(\"failure case\", exc.response);\n        if (exc.response?.getAttributeValue(\"ERROR-CODE\")[0] === 487) {\n          if (request.attributesKeys.includes(\"ICE-CONTROLLED\")) {\n            this.switchRole(true);\n          } else if (request.attributesKeys.includes(\"ICE-CONTROLLING\")) {\n            this.switchRole(false);\n          }\n          await this.checkStart(pair);\n          r();\n          return;\n        } else {\n          // timeout\n          log(\"CandidatePairState.FAILED\", pair.toJSON());\n          this.setPairState(pair, CandidatePairState.FAILED);\n          this.checkComplete(pair);\n          r();\n          return;\n        }\n      }\n\n      // # check remote address matches\n      if (!isEqual(result.addr, pair.remoteAddr)) {\n        this.setPairState(pair, CandidatePairState.FAILED);\n        this.checkComplete(pair);\n        r();\n        return;\n      }\n\n      // # success\n      if (nominate || pair.remoteNominated) {\n        // # nominated by agressive nomination or the remote party\n        pair.nominated = true;\n      } else if (this.iceControlling && !this.nominating.has(pair.component)) {\n        // # perform regular nomination\n        this.nominating.add(pair.component);\n        const request = this.buildRequest(pair, true);\n        try {\n          await pair.protocol.request(\n            request,\n            pair.remoteAddr,\n            Buffer.from(this.remotePassword, \"utf8\")\n          );\n        } catch (error) {\n          this.setPairState(pair, CandidatePairState.FAILED);\n          this.checkComplete(pair);\n          return;\n        }\n        pair.nominated = true;\n      }\n\n      this.setPairState(pair, CandidatePairState.SUCCEEDED);\n      this.checkComplete(pair);\n      r();\n    });\n\n  // 7.2.  STUN Server Procedures\n  // 7.2.1.3、7.2.1.4、および7.2.1.5\n  checkIncoming(message: Message, addr: Address, protocol: Protocol) {\n    // log(\"checkIncoming\", message.toJSON(), addr);\n    // \"\"\"\n    // Handle a successful incoming check.\n    // \"\"\"\n    const component = protocol.localCandidate?.component;\n    if (component == undefined) {\n      throw new Error(\"component not exist\");\n    }\n\n    // find remote candidate\n    let remoteCandidate: Candidate | undefined;\n    const [host, port] = addr;\n    for (const c of this.remoteCandidates) {\n      if (c.host === host && c.port === port) {\n        remoteCandidate = c;\n        if (remoteCandidate.component !== component) {\n          throw new Error(\"checkIncoming\");\n        }\n        break;\n      }\n    }\n    if (!remoteCandidate) {\n      // 7.2.1.3.  Learning Peer Reflexive Candidates\n      remoteCandidate = new Candidate(\n        randomString(10),\n        component,\n        \"udp\",\n        message.getAttributeValue(\"PRIORITY\"),\n        host,\n        port,\n        \"prflx\"\n      );\n      this.remoteCandidates.push(remoteCandidate);\n    }\n\n    // find pair\n    let pair = this.findPair(protocol, remoteCandidate);\n    if (!pair) {\n      pair = new CandidatePair(protocol, remoteCandidate);\n      this.setPairState(pair, CandidatePairState.WAITING);\n      this.checkList.push(pair);\n      this.sortCheckList();\n    }\n\n    // 7.2.1.4.  Triggered Checks\n    if (\n      [CandidatePairState.WAITING, CandidatePairState.FAILED].includes(\n        pair.state\n      )\n    ) {\n      pair.handle = future(this.checkStart(pair));\n    } else {\n      pair;\n    }\n\n    // 7.2.1.5. Updating the Nominated Flag\n    if (\n      message.attributesKeys.includes(\"USE-CANDIDATE\") &&\n      !this.iceControlling\n    ) {\n      pair.remoteNominated = true;\n      if (pair.state === CandidatePairState.SUCCEEDED) {\n        pair.nominated = true;\n        this.checkComplete(pair);\n      }\n    }\n  }\n\n  private pairRemoteCandidate = (remoteCandidate: Candidate) => {\n    for (const protocol of this.protocols) {\n      if (\n        protocol.localCandidate?.canPairWith(remoteCandidate) &&\n        !this.findPair(protocol, remoteCandidate)\n      ) {\n        const pair = new CandidatePair(protocol, remoteCandidate);\n        this.checkList.push(pair);\n        this.setPairState(pair, CandidatePairState.WAITING);\n      }\n    }\n  };\n\n  private buildRequest(pair: CandidatePair, nominate: boolean) {\n    const txUsername = `${this.remoteUsername}:${this.localUserName}`;\n    const request = new Message(methods.BINDING, classes.REQUEST);\n    request\n      .setAttribute(\"USERNAME\", txUsername)\n      .setAttribute(\"PRIORITY\", candidatePriority(pair.component, \"prflx\"));\n    if (this.iceControlling) {\n      request.setAttribute(\"ICE-CONTROLLING\", this._tieBreaker);\n      if (nominate) {\n        request.setAttribute(\"USE-CANDIDATE\", null);\n      }\n    } else {\n      request.setAttribute(\"ICE-CONTROLLED\", this._tieBreaker);\n    }\n    return request;\n  }\n\n  private respondError(\n    request: Message,\n    addr: Address,\n    protocol: Protocol,\n    errorCode: [number, string]\n  ) {\n    const response = new Message(\n      request.messageMethod,\n      classes.ERROR,\n      request.transactionId\n    );\n    response\n      .setAttribute(\"ERROR-CODE\", errorCode)\n      .addMessageIntegrity(Buffer.from(this.localPassword, \"utf8\"))\n      .addFingerprint();\n    protocol.sendStun(response, addr);\n  }\n}\n\nexport class CandidatePair {\n  handle?: Future;\n  nominated = false;\n  remoteNominated = false;\n  // 5.7.4.  Computing States\n  private _state = CandidatePairState.FROZEN;\n  get state() {\n    return this._state;\n  }\n\n  toJSON() {\n    return {\n      protocol: this.protocol.type,\n      remoteAddr: this.remoteAddr,\n    };\n  }\n\n  constructor(public protocol: Protocol, public remoteCandidate: Candidate) {}\n\n  updateState(state: CandidatePairState) {\n    this._state = state;\n  }\n\n  get localCandidate() {\n    if (!this.protocol.localCandidate)\n      throw new Error(\"localCandidate not exist\");\n    return this.protocol.localCandidate;\n  }\n\n  get remoteAddr(): Address {\n    return [this.remoteCandidate.host, this.remoteCandidate.port];\n  }\n\n  get component() {\n    return this.localCandidate.component;\n  }\n}\n\nconst ICE_COMPLETED = 1 as const;\nconst ICE_FAILED = 2 as const;\n\nconst CONSENT_INTERVAL = 5;\nconst CONSENT_FAILURES = 6;\n\nexport enum CandidatePairState {\n  FROZEN = 0,\n  WAITING = 1,\n  IN_PROGRESS = 2,\n  SUCCEEDED = 3,\n  FAILED = 4,\n}\n\ntype IceState = \"disconnected\" | \"closed\" | \"completed\" | \"new\" | \"connected\";\n\nexport interface IceOptions {\n  components: number;\n  stunServer?: Address;\n  turnServer?: Address;\n  turnUsername?: string;\n  turnPassword?: string;\n  turnSsl?: boolean;\n  turnTransport?: string;\n  forceTurn?: boolean;\n  useIpv4: boolean;\n  useIpv6: boolean;\n  portRange?: [number, number];\n  interfaceAddresses?: InterfaceAddresses;\n  additionalHostAddresses?: string[];\n  filterStunResponse?: (\n    message: Message,\n    addr: Address,\n    protocol: Protocol\n  ) => boolean;\n}\n\nconst defaultOptions: IceOptions = {\n  components: 1,\n  useIpv4: true,\n  useIpv6: true,\n};\n\nexport function validateRemoteCandidate(candidate: Candidate) {\n  // \"\"\"\n  // Check the remote candidate is supported.\n  // \"\"\"\n  if (![\"host\", \"relay\", \"srflx\"].includes(candidate.type))\n    throw new Error(`Unexpected candidate type \"${candidate.type}\"`);\n\n  // ipaddress.ip_address(candidate.host)\n  return candidate;\n}\n\nexport function sortCandidatePairs(\n  pairs: CandidatePair[],\n  iceControlling: boolean\n) {\n  pairs.sort(\n    (a, b) =>\n      candidatePairPriority(\n        a.localCandidate,\n        a.remoteCandidate,\n        iceControlling\n      ) -\n      candidatePairPriority(b.localCandidate, b.remoteCandidate, iceControlling)\n  );\n}\n\n// 5.7.2.  Computing Pair Priority and Ordering Pairs\nexport function candidatePairPriority(\n  local: Candidate,\n  remote: Candidate,\n  iceControlling: boolean\n) {\n  const G = (iceControlling && local.priority) || remote.priority;\n  const D = (iceControlling && remote.priority) || local.priority;\n  return (1 << 32) * Math.min(G, D) + 2 * Math.max(G, D) + (G > D ? 1 : 0);\n}\n\nfunction isAutoconfigurationAddress(info: os.NetworkInterfaceInfo) {\n  return (\n    normalizeFamilyNodeV18(info.family) === 4 &&\n    info.address?.startsWith(\"169.254.\")\n  );\n}\n\nfunction nodeIpAddress(family: number): string[] {\n  // https://chromium.googlesource.com/external/webrtc/+/master/rtc_base/network.cc#236\n  const costlyNetworks = [\"ipsec\", \"tun\", \"utun\", \"tap\"];\n  const banNetworks = [\"vmnet\", \"veth\"];\n\n  const interfaces = os.networkInterfaces();\n\n  const all = Object.keys(interfaces)\n    .map((nic) => {\n      for (const word of [...costlyNetworks, ...banNetworks]) {\n        if (nic.startsWith(word)) {\n          return {\n            nic,\n            addresses: [],\n          };\n        }\n      }\n      const addresses = interfaces[nic]!.filter(\n        (details) =>\n          normalizeFamilyNodeV18(details.family) === family &&\n          !nodeIp.isLoopback(details.address) &&\n          !isAutoconfigurationAddress(details)\n      );\n      return {\n        nic,\n        addresses: addresses.map((address) => address.address),\n      };\n    })\n    .filter((address) => !!address);\n\n  // os.networkInterfaces doesn't actually return addresses in a good order.\n  // have seen instances where en0 (ethernet) is after en1 (wlan), etc.\n  // eth0 > eth1\n  all.sort((a, b) => a.nic.localeCompare(b.nic));\n  return Object.values(all)\n    .map((entry) => entry.addresses)\n    .flat();\n}\n\nexport function getHostAddresses(useIpv4: boolean, useIpv6: boolean) {\n  const address: string[] = [];\n  if (useIpv4) address.push(...nodeIpAddress(4));\n  if (useIpv6) address.push(...nodeIpAddress(6));\n  return address;\n}\n\nexport async function serverReflexiveCandidate(\n  protocol: Protocol,\n  stunServer: Address\n) {\n  // \"\"\"\n  // Query STUN server to obtain a server-reflexive candidate.\n  // \"\"\"\n\n  // # perform STUN query\n  const request = new Message(methods.BINDING, classes.REQUEST);\n  try {\n    const [response] = await protocol.request(request, stunServer);\n\n    const localCandidate = protocol.localCandidate;\n    if (!localCandidate) throw new Error(\"not exist\");\n\n    return new Candidate(\n      candidateFoundation(\"srflx\", \"udp\", localCandidate.host),\n      localCandidate.component,\n      localCandidate.transport,\n      candidatePriority(localCandidate.component, \"srflx\"),\n      response.getAttributeValue(\"XOR-MAPPED-ADDRESS\")[0],\n      response.getAttributeValue(\"XOR-MAPPED-ADDRESS\")[1],\n      \"srflx\",\n      localCandidate.host,\n      localCandidate.port\n    );\n  } catch (error) {\n    // todo fix\n    log(\"error serverReflexiveCandidate\", error);\n  }\n}\n\nexport function validateAddress(addr?: Address): Address | undefined {\n  if (addr && isNaN(addr[1])) {\n    return [addr[0], 443];\n  }\n  return addr;\n}\n"]}