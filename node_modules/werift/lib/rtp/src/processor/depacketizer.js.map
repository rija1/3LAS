{"version":3,"file":"depacketizer.js","sourceRoot":"","sources":["../../../../../rtp/src/processor/depacketizer.ts"],"names":[],"mappings":";;;;;;AAAA,kDAA0B;AAC1B,sDAA4B;AAE5B,0BAA+D;AAC/D,oCAAiD;AACjD,sCAAsC;AAGtC,MAAM,IAAI,GAAG,yDAAyD,CAAC;AACvE,MAAM,GAAG,GAAG,IAAA,eAAK,EAAC,IAAI,CAAC,CAAC;AA2BxB,MAAa,eAAe;IAW1B,YACU,KAAa,EACb,UAA+B,EAAE;;;;;mBADjC;;;;;;mBACA;;QAVV;;;;mBAAyC,EAAE;WAAC;QAC5C;;;;;WAA4B;QAC5B;;;;mBAAsB,KAAK;WAAC;QAC5B;;;;mBAA2B,KAAK;WAAC;QACjC;;;;mBAAQ,CAAC;WAAC;QACV;;;;mBAA0B,IAAI,iBAAK,EAAE;WAAC;QACtC;;;;mBAAwB,EAAE;WAAC;IAKxB,CAAC;IAEJ,MAAM;QACJ,OAAO;YACL,eAAe,EAAE,IAAI,CAAC,SAAS,CAAC,MAAM;YACtC,UAAU,EAAE,IAAI,CAAC,UAAU;YAC3B,KAAK,EAAE,IAAI,CAAC,KAAK;YACjB,KAAK,EAAE,IAAI,CAAC,aAAa;SAC1B,CAAC;IACJ,CAAC;IAED,YAAY,CAAC,KAAwB;QACnC,MAAM,MAAM,GAAyB,EAAE,CAAC;QACxC,IAAI,CAAC,KAAK,CAAC,GAAG,EAAE;YACd,IAAI,KAAK,CAAC,GAAG,EAAE;gBACb,MAAM,CAAC,IAAI,CAAC,EAAE,GAAG,EAAE,IAAI,EAAE,CAAC,CAAC;gBAC3B,IAAI,CAAC,IAAI,EAAE,CAAC;aACb;YACD,OAAO,MAAM,CAAC;SACf;QAED,IAAI,IAAI,CAAC,OAAO,CAAC,uBAAuB,EAAE;YACxC,MAAM,OAAO,GAAG,IAAI,CAAC,gBAAgB,CAAC,KAAK,CAAC,CAAC;YAC7C,IAAI,OAAO,EAAE;gBACX,IAAI;oBACF,MAAM,EAAE,IAAI,EAAE,UAAU,EAAE,QAAQ,EAAE,SAAS,EAAE,GAC7C,IAAA,6BAAqB,EACnB,IAAI,CAAC,KAAK,EACV,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,GAAI,CAAC,CAClC,CAAC;oBAEJ,IAAI,UAAU,EAAE;wBACd,IAAI,CAAC,gBAAgB,GAAG,IAAI,CAAC;qBAC9B;oBAED,IAAI,IAAI,CAAC,OAAO,CAAC,eAAe,IAAI,IAAI,CAAC,gBAAgB,KAAK,KAAK,EAAE;wBACnE,IAAI,CAAC,cAAc,CAAC,OAAO,EAAE,CAAC;wBAC9B,OAAO,EAAE,CAAC;qBACX;oBAED,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE;wBACrB,MAAM,IAAI,GAAG,IAAI,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,EAAE,IAAI,IAAI,CAAC,CAAC;wBAC9C,MAAM,CAAC,IAAI,CAAC;4BACV,KAAK,EAAE;gCACL,IAAI;gCACJ,UAAU;gCACV,IAAI;gCACJ,QAAQ,EAAE,IAAI,CAAC,KAAK,EAAE;gCACtB,MAAM,EAAE,QAAQ;gCAChB,SAAS;6BACV;yBACF,CAAC,CAAC;qBACJ;oBAED,IAAI,IAAI,CAAC,WAAW,EAAE;wBACpB,IAAI,CAAC,WAAW,GAAG,KAAK,CAAC;qBAC1B;oBAED,IAAI,CAAC,WAAW,EAAE,CAAC;oBAEnB,OAAO,MAAM,CAAC;iBACf;gBAAC,OAAO,KAAK,EAAE;oBACd,GAAG,CAAC,OAAO,EAAE,KAAK,EAAE,EAAE,KAAK,EAAE,KAAK,EAAE,IAAI,CAAC,KAAK,EAAE,CAAC,CAAC;oBAClD,IAAI,CAAC,WAAW,EAAE,CAAC;iBACpB;aACF;SACF;aAAM;YACL,IAAI;gBACF,MAAM,EAAE,IAAI,EAAE,UAAU,EAAE,QAAQ,EAAE,SAAS,EAAE,GAAG,IAAA,6BAAqB,EACrE,IAAI,CAAC,KAAK,EACV,CAAC,KAAK,CAAC,GAAG,CAAC,CACZ,CAAC;gBACF,MAAM,CAAC,IAAI,CAAC;oBACV,KAAK,EAAE;wBACL,IAAI;wBACJ,UAAU;wBACV,IAAI,EAAE,KAAK,CAAC,IAAK;wBACjB,QAAQ,EAAE,IAAI,CAAC,KAAK,EAAE;wBACtB,MAAM,EAAE,QAAQ;wBAChB,SAAS;qBACV;iBACF,CAAC,CAAC;gBACH,OAAO,MAAM,CAAC;aACf;YAAC,OAAO,KAAK,EAAE;gBACd,GAAG,CAAC,OAAO,EAAE,KAAK,EAAE,EAAE,KAAK,EAAE,KAAK,EAAE,IAAI,CAAC,KAAK,EAAE,CAAC,CAAC;aACnD;SACF;QACD,OAAO,EAAE,CAAC;IACZ,CAAC;IAEO,IAAI;QACV,IAAI,CAAC,WAAW,EAAE,CAAC;QACnB,IAAI,CAAC,cAAc,CAAC,cAAc,EAAE,CAAC;IACvC,CAAC;IAEO,WAAW;QACjB,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,GAAI,CAAC,KAAK,EAAE,CAAC,CAAC;QAC9C,IAAI,CAAC,SAAS,GAAG,EAAE,CAAC;IACtB,CAAC;IAEO,gBAAgB,CAAC,EAAE,GAAG,EAAE,IAAI,EAAqB;QACvD,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,uBAAuB,EAAE;YACzC,MAAM,IAAI,KAAK,CAAC,mCAAmC,CAAC,CAAC;SACtD;QAED,MAAM,EAAE,cAAc,EAAE,GAAG,GAAI,CAAC,MAAM,CAAC;QACvC,IAAI,IAAI,CAAC,UAAU,IAAI,SAAS,EAAE;YAChC,MAAM,MAAM,GAAG,IAAA,aAAS,EAAC,IAAI,CAAC,UAAU,EAAE,CAAC,CAAC,CAAC;YAC7C,IAAI,IAAA,YAAQ,EAAC,MAAM,EAAE,cAAc,CAAC,EAAE;gBACpC,IAAI,CAAC,aAAa,CAAC,UAAU,CAAC,GAAG;oBAC/B,MAAM;oBACN,cAAc;oBACd,KAAK,EAAE,IAAI,CAAC,KAAK;oBACjB,EAAE,EAAE,IAAI,IAAI,EAAE,CAAC,WAAW,EAAE;oBAC5B,KAAK,EAAE,CAAC,IAAI,CAAC,aAAa,CAAC,UAAU,CAAC,EAAE,KAAK,IAAI,CAAC,CAAC,GAAG,CAAC;iBACxD,CAAC;gBACF,OAAO,KAAK,CAAC;aACd;YACD,IAAI,IAAA,YAAQ,EAAC,cAAc,EAAE,MAAM,CAAC,EAAE;gBACpC,IAAI,CAAC,aAAa,CAAC,YAAY,CAAC,GAAG;oBACjC,MAAM;oBACN,cAAc;oBACd,KAAK,EAAE,IAAI,CAAC,KAAK;oBACjB,EAAE,EAAE,IAAI,IAAI,EAAE,CAAC,WAAW,EAAE;oBAC5B,KAAK,EAAE,CAAC,IAAI,CAAC,aAAa,CAAC,YAAY,CAAC,EAAE,KAAK,IAAI,CAAC,CAAC,GAAG,CAAC;iBAC1D,CAAC;gBACF,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC;gBACxB,IAAI,CAAC,WAAW,EAAE,CAAC;aACpB;SACF;QAED,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,EAAE,GAAG,EAAE,IAAI,EAAE,CAAC,CAAC;QACnC,IAAI,CAAC,UAAU,GAAG,cAAc,CAAC;QAEjC,IAAI,WAA+B,CAAC;QACpC,KAAK,MAAM,CAAC,CAAC,EAAE,EAAE,GAAG,EAAE,CAAC,IAAI,IAAA,kBAAS,EAAC,IAAI,CAAC,SAAS,CAAC,EAAE;YACpD,IAAI,IAAI,CAAC,OAAO,CAAC,uBAAuB,CAAC,GAAI,CAAC,MAAM,CAAC,EAAE;gBACrD,WAAW,GAAG,CAAC,CAAC;gBAChB,MAAM;aACP;SACF;QACD,IAAI,WAAW,IAAI,SAAS,EAAE;YAC5B,OAAO,KAAK,CAAC;SACd;QAED,OAAO,IAAI,CAAC;IACd,CAAC;CACF;AAjKD,0CAiKC","sourcesContent":["import debug from \"debug\";\nimport Event from \"rx.mini\";\n\nimport { RtpHeader, RtpPacket, uint16Add, uint16Gt } from \"..\";\nimport { dePacketizeRtpPackets } from \"../codec\";\nimport { enumerate } from \"../helper\";\nimport { Processor } from \"./interface\";\n\nconst path = `werift-rtp : packages/rtp/src/processor/depacketizer.ts`;\nconst log = debug(path);\n\nexport type DepacketizerInput = {\n  rtp?: RtpPacket;\n  /**ms */\n  time?: number;\n  eol?: boolean;\n};\n\nexport interface DepacketizerOutput {\n  frame?: CodecFrame;\n  eol?: boolean;\n}\n\nexport interface CodecFrame {\n  data: Buffer;\n  isKeyframe: boolean;\n  /**ms */\n  time: number;\n  [key: string]: any;\n}\n\nexport interface DepacketizerOptions {\n  isFinalPacketInSequence?: (header: RtpHeader) => boolean;\n  waitForKeyframe?: boolean;\n}\n\nexport class DepacketizeBase\n  implements Processor<DepacketizerInput, DepacketizerOutput>\n{\n  private buffering: DepacketizerInput[] = [];\n  private lastSeqNum?: number;\n  private frameBroken = false;\n  private keyframeReceived = false;\n  count = 0;\n  readonly onNeedKeyFrame = new Event();\n  private internalStats = {};\n\n  constructor(\n    private codec: string,\n    private options: DepacketizerOptions = {}\n  ) {}\n\n  toJSON(): Record<string, any> {\n    return {\n      bufferingLength: this.buffering.length,\n      lastSeqNum: this.lastSeqNum,\n      count: this.count,\n      stats: this.internalStats,\n    };\n  }\n\n  processInput(input: DepacketizerInput): DepacketizerOutput[] {\n    const output: DepacketizerOutput[] = [];\n    if (!input.rtp) {\n      if (input.eol) {\n        output.push({ eol: true });\n        this.stop();\n      }\n      return output;\n    }\n\n    if (this.options.isFinalPacketInSequence) {\n      const isFinal = this.checkFinalPacket(input);\n      if (isFinal) {\n        try {\n          const { data, isKeyframe, sequence, timestamp } =\n            dePacketizeRtpPackets(\n              this.codec,\n              this.buffering.map((b) => b.rtp!)\n            );\n\n          if (isKeyframe) {\n            this.keyframeReceived = true;\n          }\n\n          if (this.options.waitForKeyframe && this.keyframeReceived === false) {\n            this.onNeedKeyFrame.execute();\n            return [];\n          }\n\n          if (!this.frameBroken) {\n            const time = this.buffering.at(-1)?.time ?? 0;\n            output.push({\n              frame: {\n                data,\n                isKeyframe,\n                time,\n                sequence: this.count++,\n                rtpSeq: sequence,\n                timestamp,\n              },\n            });\n          }\n\n          if (this.frameBroken) {\n            this.frameBroken = false;\n          }\n\n          this.clearBuffer();\n\n          return output;\n        } catch (error) {\n          log(\"error\", error, { input, codec: this.codec });\n          this.clearBuffer();\n        }\n      }\n    } else {\n      try {\n        const { data, isKeyframe, sequence, timestamp } = dePacketizeRtpPackets(\n          this.codec,\n          [input.rtp]\n        );\n        output.push({\n          frame: {\n            data,\n            isKeyframe,\n            time: input.time!,\n            sequence: this.count++,\n            rtpSeq: sequence,\n            timestamp,\n          },\n        });\n        return output;\n      } catch (error) {\n        log(\"error\", error, { input, codec: this.codec });\n      }\n    }\n    return [];\n  }\n\n  private stop() {\n    this.clearBuffer();\n    this.onNeedKeyFrame.allUnsubscribe();\n  }\n\n  private clearBuffer() {\n    this.buffering.forEach((b) => b.rtp!.clear());\n    this.buffering = [];\n  }\n\n  private checkFinalPacket({ rtp, time }: DepacketizerInput): boolean {\n    if (!this.options.isFinalPacketInSequence) {\n      throw new Error(\"isFinalPacketInSequence not exist\");\n    }\n\n    const { sequenceNumber } = rtp!.header;\n    if (this.lastSeqNum != undefined) {\n      const expect = uint16Add(this.lastSeqNum, 1);\n      if (uint16Gt(expect, sequenceNumber)) {\n        this.internalStats[\"unExpect\"] = {\n          expect,\n          sequenceNumber,\n          codec: this.codec,\n          at: new Date().toISOString(),\n          count: (this.internalStats[\"unExpect\"]?.count ?? 0) + 1,\n        };\n        return false;\n      }\n      if (uint16Gt(sequenceNumber, expect)) {\n        this.internalStats[\"packetLost\"] = {\n          expect,\n          sequenceNumber,\n          codec: this.codec,\n          at: new Date().toISOString(),\n          count: (this.internalStats[\"packetLost\"]?.count ?? 0) + 1,\n        };\n        this.frameBroken = true;\n        this.clearBuffer();\n      }\n    }\n\n    this.buffering.push({ rtp, time });\n    this.lastSeqNum = sequenceNumber;\n\n    let finalPacket: number | undefined;\n    for (const [i, { rtp }] of enumerate(this.buffering)) {\n      if (this.options.isFinalPacketInSequence(rtp!.header)) {\n        finalPacket = i;\n        break;\n      }\n    }\n    if (finalPacket == undefined) {\n      return false;\n    }\n\n    return true;\n  }\n}\n"]}