{"version":3,"file":"webm.js","sourceRoot":"","sources":["../../../../../rtp/src/processor/webm.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  getEBMLByteLength,\n  numberToByteArray,\n  vintEncode,\n} from \"../container/ebml\";\nimport { SupportedCodec, WEBMBuilder } from \"../container/webm\";\nimport { AVProcessor } from \"./interface\";\n\nexport type WebmInput = {\n  frame?: {\n    data: Buffer;\n    isKeyframe: boolean;\n    /**ms */\n    time: number;\n  };\n  eol?: boolean;\n};\n\nexport interface WebmOutput {\n  saveToFile?: Buffer;\n  kind?: \"initial\" | \"cluster\" | \"block\" | \"cuePoints\";\n  /**ms */\n  previousDuration?: number;\n  eol?: {\n    /**ms */\n    duration: number;\n    durationElement: Uint8Array;\n    header: Buffer;\n  };\n}\n\nexport interface WebmOption {\n  /**ms */\n  duration?: number;\n  encryptionKey?: Buffer;\n  strictTimestamp?: boolean;\n}\n\nexport class WebmBase implements AVProcessor<WebmInput> {\n  private builder: WEBMBuilder;\n  private relativeTimestamp = 0;\n  private timestamps: { [pt: number]: ClusterTimestamp } = {};\n  private cuePoints: CuePoint[] = [];\n  private position = 0;\n  private clusterCounts = 0;\n  elapsed?: number;\n  audioStopped = false;\n  videoStopped = false;\n  stopped = false;\n  videoKeyframeReceived = false;\n  internalStats = {};\n\n  constructor(\n    public tracks: {\n      width?: number;\n      height?: number;\n      kind: \"audio\" | \"video\";\n      codec: SupportedCodec;\n      clockRate: number;\n      trackNumber: number;\n    }[],\n    private output: (output: WebmOutput) => void,\n    private options: WebmOption = {}\n  ) {\n    this.builder = new WEBMBuilder(tracks, options.encryptionKey);\n\n    tracks.forEach((t) => {\n      this.timestamps[t.trackNumber] = new ClusterTimestamp();\n    });\n  }\n\n  toJSON(): Record<string, any> {\n    return { ...this.internalStats };\n  }\n\n  private processInput(input: WebmInput, trackNumber: number) {\n    if (this.stopped) return;\n\n    const track = this.tracks.find((t) => t.trackNumber === trackNumber);\n    if (!track) {\n      throw new Error(\"track not found\");\n    }\n\n    if (!input.frame) {\n      if (this.tracks.length === 2) {\n        if (track.kind === \"audio\") {\n          this.audioStopped = true;\n          this.internalStats[\"audioStopped\"] = new Date().toISOString();\n          if (this.videoStopped) {\n            this.stop();\n          }\n        } else {\n          this.videoStopped = true;\n          this.internalStats[\"videoStopped\"] = new Date().toISOString();\n          if (this.audioStopped) {\n            this.stop();\n          }\n        }\n      } else if (input.eol) {\n        this.internalStats[\"input.eol\"] = new Date().toISOString();\n        this.stop();\n      }\n\n      return;\n    }\n\n    if (track.kind === \"audio\") {\n      this.audioStopped = false;\n    } else {\n      this.videoStopped = false;\n    }\n\n    this.onFrameReceived({ ...input.frame, trackNumber });\n  }\n\n  processAudioInput = (input: WebmInput) => {\n    const track = this.tracks.find((t) => t.kind === \"audio\");\n    if (track) {\n      this.internalStats[\"processAudioInput\"] = new Date().toISOString();\n      this.processInput(input, track.trackNumber);\n    }\n  };\n\n  processVideoInput = (input: WebmInput) => {\n    if (input.frame?.isKeyframe) {\n      this.videoKeyframeReceived = true;\n    }\n\n    const track = this.tracks.find((t) => t.kind === \"video\");\n    if (track) {\n      this.internalStats[\"processVideoInput\"] = new Date().toISOString();\n      this.processInput(input, track.trackNumber);\n    }\n  };\n\n  protected start() {\n    const staticPart = Buffer.concat([\n      this.builder.ebmlHeader,\n      this.builder.createSegment(this.options.duration),\n    ]);\n    this.output({ saveToFile: staticPart, kind: \"initial\" });\n    this.position += staticPart.length;\n\n    const video = this.tracks.find((t) => t.kind === \"video\");\n    if (video) {\n      this.cuePoints.push(\n        new CuePoint(this.builder, video.trackNumber, 0.0, this.position)\n      );\n    }\n  }\n\n  private onFrameReceived(frame: WebmInput[\"frame\"] & { trackNumber: number }) {\n    const track = this.tracks.find((t) => t.trackNumber === frame.trackNumber);\n    if (!track) {\n      return;\n    }\n\n    this.internalStats[\"onFrameReceived_trackNumber\" + frame.trackNumber] =\n      new Date().toISOString();\n    this.internalStats[\"onFrameReceived_count\"] =\n      (this.internalStats[\"onFrameReceived_count\"] ?? 0) + 1;\n\n    const timestampManager = this.timestamps[track.trackNumber];\n    if (timestampManager.baseTime == undefined) {\n      for (const t of Object.values(this.timestamps)) {\n        t.baseTime = frame.time;\n      }\n    }\n\n    // clusterの経過時間 ms\n    let elapsed = timestampManager.update(frame.time);\n\n    if (this.clusterCounts === 0) {\n      this.createCluster(0.0, 0);\n    } else if (\n      (track.kind === \"video\" && frame.isKeyframe) ||\n      // simpleBlockのタイムスタンプはsigned 16bitだから\n      elapsed > MaxSinged16Int\n    ) {\n      this.relativeTimestamp += elapsed;\n\n      if (elapsed !== 0) {\n        this.cuePoints.push(\n          new CuePoint(\n            this.builder,\n            track.trackNumber,\n            this.relativeTimestamp,\n            this.position\n          )\n        );\n\n        this.createCluster(this.relativeTimestamp, elapsed);\n        Object.values(this.timestamps).forEach((t) => t.shift(elapsed));\n        elapsed = timestampManager.update(frame.time);\n      }\n    }\n\n    if (elapsed >= 0) {\n      this.createSimpleBlock({\n        frame,\n        trackNumber: track.trackNumber,\n        elapsed,\n      });\n    } else {\n      this.internalStats[\"delayed_frame\"] = {\n        elapsed,\n        trackNumber: track.trackNumber,\n        timestamp: new Date().toISOString(),\n        count: (this.internalStats[\"delayed_frame\"]?.count ?? 0) + 1,\n      };\n    }\n  }\n\n  private createCluster(\n    timestamp: number,\n    /**ms */\n    duration: number\n  ) {\n    const cluster = this.builder.createCluster(timestamp);\n    this.clusterCounts++;\n    this.output({\n      saveToFile: Buffer.from(cluster),\n      kind: \"cluster\",\n      previousDuration: duration,\n    });\n    this.position += cluster.length;\n    this.elapsed = undefined;\n  }\n\n  private createSimpleBlock({\n    frame,\n    trackNumber,\n    elapsed,\n  }: {\n    frame: NonNullable<WebmInput[\"frame\"]>;\n    trackNumber: number;\n    elapsed: number;\n  }) {\n    if (this.elapsed == undefined) {\n      this.elapsed = elapsed;\n    }\n    if (elapsed < this.elapsed && this.options.strictTimestamp) {\n      this.internalStats[\"previous_timestamp\"] = {\n        elapsed,\n        present: this.elapsed,\n        trackNumber,\n        timestamp: new Date().toISOString(),\n        count: (this.internalStats[\"previous_timestamp\"]?.count ?? 0) + 1,\n      };\n      return;\n    }\n    this.elapsed = elapsed;\n\n    const block = this.builder.createSimpleBlock(\n      frame.data,\n      frame.isKeyframe,\n      trackNumber,\n      elapsed\n    );\n\n    this.internalStats[\"createSimpleBlock_trackNumber\" + trackNumber] =\n      new Date().toISOString();\n\n    this.output({ saveToFile: block, kind: \"block\" });\n    this.position += block.length;\n    const [cuePoint] = this.cuePoints.slice(-1);\n    if (cuePoint) {\n      cuePoint.blockNumber++;\n    }\n  }\n\n  private stop() {\n    if (this.stopped) {\n      return;\n    }\n    this.stopped = true;\n\n    const latestTimestamp = Object.values(this.timestamps)\n      .sort((a, b) => a.elapsed - b.elapsed)\n      .reverse()[0].elapsed;\n    const duration = this.relativeTimestamp + latestTimestamp;\n\n    const cues = this.builder.createCues(this.cuePoints.map((c) => c.build()));\n    this.output({\n      saveToFile: Buffer.from(cues),\n      kind: \"cuePoints\",\n      previousDuration: duration,\n    });\n\n    const durationElement = this.builder.createDuration(duration);\n    const header = Buffer.concat([\n      this.builder.ebmlHeader,\n      this.builder.createSegment(duration),\n    ]);\n\n    this.output({ eol: { duration, durationElement, header } });\n\n    this.timestamps = {};\n    this.cuePoints = [];\n    this.internalStats = {};\n    this.output = undefined as any;\n  }\n}\n\nclass ClusterTimestamp {\n  /**ms */\n  baseTime?: number;\n  /**ms */\n  elapsed = 0;\n  private offset = 0;\n\n  shift(\n    /**ms */\n    elapsed: number\n  ) {\n    this.offset += elapsed;\n  }\n\n  update(\n    /**ms */\n    time: number\n  ) {\n    if (this.baseTime == undefined) {\n      throw new Error(\"baseTime not exist\");\n    }\n\n    this.elapsed = time - this.baseTime - this.offset;\n\n    return this.elapsed;\n  }\n}\n\nclass CuePoint {\n  /**\n   * cuesの後のclusterのあるべき位置\n   * cuesはclusterの前に挿入される\n   */\n  cuesLength = 0;\n  blockNumber = 0;\n\n  constructor(\n    private readonly builder: WEBMBuilder,\n    private readonly trackNumber: number,\n    private readonly relativeTimestamp: number,\n    public position: number\n  ) {}\n\n  build() {\n    return this.builder.createCuePoint(\n      this.relativeTimestamp,\n      this.trackNumber,\n      this.position - 48 + this.cuesLength,\n      this.blockNumber\n    );\n  }\n}\n\n/**4294967295 */\nexport const Max32Uint = Number(0x01n << 32n) - 1;\n/**32767 */\nexport const MaxSinged16Int = (0x01 << 16) / 2 - 1;\n\nexport const DurationPosition = 83;\n\nexport const SegmentSizePosition = 40;\n\nexport function replaceSegmentSize(totalFileSize: number) {\n  const bodySize = totalFileSize - SegmentSizePosition;\n  const resize = [\n    ...vintEncode(numberToByteArray(bodySize, getEBMLByteLength(bodySize))),\n  ];\n  const todoFill = 8 - resize.length - 2;\n  if (todoFill > 0) {\n    resize.push(0xec);\n    if (todoFill > 1) {\n      const voidSize = vintEncode(\n        numberToByteArray(todoFill, getEBMLByteLength(todoFill))\n      );\n      [...voidSize].forEach((i) => resize.push(i));\n    }\n  }\n  return Buffer.from(resize);\n}\n"]}