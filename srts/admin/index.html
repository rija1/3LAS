<!DOCTYPE html>
<html>

<head>
    <title>Thrangu Sekhar Translation</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <h1>Thrangu Sekhar Translation Services</h1>
        <h2>Administration Panel</h2>

        <div class="status-actions">
            <button id="start-all-button">Start All</button>
            <button id="stop-all-button">Stop All</button>
            <button id="restart-all-button">Restart All</button>
        </div>

        <div class="status-container" id="status-container">

            <div class="status-header">
                <div>Status</div>
                <div>Process Name</div>
                <div>Uptime</div>
                <div>Process Management</div>
                <div>Settings</div>
            </div>
        </div>

        <script>

            // Function to start a PM2 process
            function startPM2(processName) {
                socket.emit('start-process', processName);
            }

            // Function to stop a PM2 process
            function stopPM2(processName) {
                socket.emit('stop-process', processName);
            }

            // Function to stop a PM2 process
            function restartPM2(processName) {
                socket.emit('restart-process', processName);
            }

            function startAll(settingsInfo) {
                for (const channelId in settingsInfo.channels) {
                    startPM2(channelId);
                }
            }

            function stopAll(settingsInfo) {
                for (const channelId in settingsInfo.channels) {
                    stopPM2(channelId);
                }
            }

            function restartAll(settingsInfo) {
                for (const channelId in settingsInfo.channels) {
                    restartPM2(channelId);
                }
            }

            function createChannelsInfo(settingsInfo) {
                for (const channelId in settingsInfo.channels) {

                    const channel = settingsInfo.channels[channelId];
                    const statusItem = document.createElement('div');
                    statusItem.className = 'status-item';
                    statusItem.setAttribute('id', channelId);
                    statusContainer.appendChild(statusItem);

                    // Add status indicator column
                    const statusIndicatorContainer = document.createElement('div');
                    statusIndicatorContainer.className = 'status-indicator-container';
                    statusItem.appendChild(statusIndicatorContainer);
                    const statusIndicator = document.createElement('div');
                    statusIndicator.className = 'status-indicator';
                    statusIndicatorContainer.appendChild(statusIndicator);

                    // Add process name column
                    const processInfo = document.createElement('div');
                    processInfo.style.verticalAlign = 'middle';
                    processInfo.className = 'channel-name';
                    processInfo.textContent = channel.name;
                    statusItem.appendChild(processInfo);

                    // Add elapsed time column
                    const elapsedTimeDiv = document.createElement('div');
                    elapsedTimeDiv.className = 'elapsed-time';
                    statusItem.appendChild(elapsedTimeDiv);

                    // Add start/stop buttons column
                    const buttonsContainer = document.createElement('div');
                    buttonsContainer.className = 'buttons-container';
                    statusItem.appendChild(buttonsContainer);
                    const startButton = document.createElement('button');
                    startButton.textContent = 'Start';
                    startButton.onclick = () => {
                        startPM2(channelId);
                    };
                    const stopButton = document.createElement('button');
                    stopButton.textContent = 'Stop';
                    stopButton.onclick = () => {
                        stopPM2(channelId);
                    };
                    buttonsContainer.appendChild(startButton);
                    buttonsContainer.appendChild(stopButton);

                    // Add Channel Options block
                    const channelOptions = document.createElement('div');
                    channelOptions.className = 'channel-options';
                    statusItem.appendChild(channelOptions);

                    // Add language name column
                    const languageSelect = document.createElement('select');
                    languageSelect.className = 'language-select';

                    const option = document.createElement('option');
                    option.value = '';
                    option.text = 'Select Language';
                    languageSelect.appendChild(option);

                    // Loop through the object keys and values and create options
                    for (const [code, language] of Object.entries(settingsInfo.languages)) {
                        const option = document.createElement('option');
                        option.value = code;
                        option.text = language.name;
                        languageSelect.appendChild(option);
                    }

                    const languageLabel = document.createElement('label');
                    languageLabel.textContent = "Language";
                    const languageBlock = document.createElement('div');
                    languageBlock.className = 'language-block';

                    languageBlock.appendChild(languageLabel);
                    languageBlock.appendChild(languageSelect);
                    channelOptions.appendChild(languageBlock);

                    const cpServerCheckbox = document.createElement('input');
                    cpServerCheckbox.type = 'checkbox';
                    cpServerCheckbox.id = 'copy_to_server';

                    const cpServerLabel = document.createElement('label');
                    cpServerLabel.htmlFor = 'copy_to_server';
                    cpServerLabel.appendChild(document.createTextNode('Copy to Server'));

                    const cpServerBlock = document.createElement('div');
                    cpServerBlock.className = 'cp-server-block';

                    cpServerBlock.appendChild(cpServerCheckbox);
                    cpServerBlock.appendChild(cpServerLabel);
                    channelOptions.appendChild(cpServerBlock);


                    // Listen for status updates from server
                    socket.on(`${channelId}-status`, (isRunning) => {
                        if (isRunning) {
                            statusIndicator.classList.add('greenIndicator');
                            statusIndicator.classList.remove('redIndicator');
                            startButton.disabled = true;
                            stopButton.disabled = false;
                        } else {
                            statusIndicator.classList.add('redIndicator');
                            statusIndicator.classList.remove('greenIndicator');
                            startButton.disabled = false;
                            stopButton.disabled = true;
                            elapsedTimeDiv.textContent = '';
                        }
                    });

                    // Listen for elapsed time updates from server
                    socket.on(`${channelId}-time`, (elapsedTime) => {
                        if (elapsedTime) {
                            elapsedTimeDiv.innerHTML = elapsedTime;
                        }
                    });

                }

            }

            // TODO : finish this : get elapsedTime, green or red status and other things like dropdown language etc
            function updatesettingsInfo(settingsInfo) {
                for (const channelId in settingsInfo.channels) {
                    const channel = settingsInfo[channelId];
                    channelStatusItem = document.querySelector("#" + channelId);
                    channelStatusItem.querySelector('.channel-name').textContent = channel.name;

                }
            }


            const statusContainer = document.getElementById('status-container');
            const socket = io();

            // TODO create socket in server etc
            // Add an event listener for the 'return-value' event on the socket
            socket.on('settings-info-update', (settingsInfo) => {
                updateChannelsInfo(settingsInfo);
            });

            // Add an event listener for the 'return-value' event on the socket
            socket.on('settings-info-value', (settingsInfo) => {
                createChannelsInfo(settingsInfo);

                document.querySelector("#start-all-button").onclick = function () { startAll(settingsInfo); };
                // alert(document.querySelector("#start-all-button").onclick);
                document.querySelector("#restart-all-button").onclick = function () { restartAll(settingsInfo); };
                document.querySelector("#stop-all-button").onclick = function () { stopAll(settingsInfo); };

            });

            // Emit a 'settings-info-value' event to the server to trigger the function call
            socket.emit('settings-info');


            // DEBUG
            // Create a new div
            const reedzDebug = document.createElement('div');



            // Add the new div inside the existing div
            document.querySelector('.status-actions').appendChild(reedzDebug);
            // Listen for status updates from server
            socket.on(`reedzdebug`, (debug) => {
                reedzDebug.textContent = debug;
            });

        </script>

</body>
</div>

</html>