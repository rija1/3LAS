<!DOCTYPE html>
<html>

<head>
    <title>Thrangu Sekhar Translation</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <h1>Thrangu Sekhar Translation Services</h1>
        <h2>Administration Panel</h2>


        <div class="wide-block">
            <div class="wide-header">Settings</div>
            <div class="wide-content">
                <label for="profile">Profile</label>
                <select id="profile"></select>
                <button id="load_profile_btn">Load Profile</button>
                <button id="save_profile_btn">Save Profile</button>
                <button id="save_new_profile_btn">Save As New Profile</button>
                <button id="del_profile_btn">Delete Profile</button>

                <!-- Popup -->
                <div id="profile_popup" style="display:none">
                    <label for="profile_name">Profile Name:</label>
                    <input type="text" id="profile_name" name="profile_name">
                    <button id="save_popup_btn">Save</button>
                </div>
                <div id="profile_popup_result" style="display:none"></div>
            </div>

        </div>



        <div class="wide-block">
            <div class="wide-header">Teaching Info</div>
            <div class="wide-content">
                <label for="teaching_lama">Lama / Teacher</label>
                <select id="teaching_lama"></select>
                <label for="teaching_name">Teaching</label>
                <select id="teaching_name"></select>
                <label for="teaching_name">Server Copy Folder</label>
                <select id="teaching_copy_folder"></select>
            </div>

        </div>

        <div class="wide-block">
            <div class="wide-header">Actions</div>
            <div class="wide-content">
                <button id="start-all-button">Start All</button>
                <button id="stop-all-button">Stop All</button>
                <button id="restart-all-button">Restart All</button>
            </div>
        </div>

        <div class="status-container" id="status-container">

            <div class="status-header">
                <div>Status</div>
                <div>Process Name</div>
                <div>Uptime</div>
                <div>Process Management</div>
                <div>Settings</div>
            </div>
        </div>

        <script>
            ////
            const saveProfileBtn = document.querySelector("#save_new_profile_btn");
            const profilePopup = document.querySelector("#profile_popup");
            const profileNameInput = document.querySelector("#profile_name");

            // Show the profile popup when the save profile button is clicked
            saveProfileBtn.addEventListener("click", () => {
                profilePopup.style.display = "block";
            });

            // Save the profile when the save button in the popup is clicked
            const savePopupBtn = document.querySelector("#save_popup_btn");
            savePopupBtn.addEventListener("click", () => {

                socket.emit('profile-new', profileNameInput.value);

                // Hide the profile popup
                profilePopup.style.display = "none";
            });
            ////

            // Function to start a PM2 process
            function startPM2(processName) {
                socket.emit('start-process', processName);
            }

            // Function to stop a PM2 process
            function stopPM2(processName) {
                socket.emit('stop-process', processName);
            }

            // Function to stop a PM2 process
            function restartPM2(processName) {
                socket.emit('restart-process', processName);
            }

            function startAll(settingsInfo) {
                for (const channelId in settingsInfo.channels) {
                    startPM2(channelId);
                }
            }

            function stopAll(settingsInfo) {
                for (const channelId in settingsInfo.channels) {
                    stopPM2(channelId);
                }
            }

            function restartAll(settingsInfo) {
                for (const channelId in settingsInfo.channels) {
                    restartPM2(channelId);
                }
            }

            function emitUpdateTeachingInfo(infoArray) {
                // Check if infoArray has the expected properties
                if (
                    typeof infoArray === 'object' && // Check if infoArray is an object
                    infoArray.hasOwnProperty('field') && // Check if infoArray has the 'field' property
                    infoArray.hasOwnProperty('value') // Check if infoArray has the 'value' property
                ) {
                    socket.emit('update-teaching-info', infoArray);
                } else {
                    console.log('Invalid infoArray format');
                }
            }

            function emitUpdateChannelInfo(infoArray) {
                // Check if infoArray has the expected properties
                if (
                    typeof infoArray === 'object' && // Check if infoArray is an object
                    infoArray.hasOwnProperty('field') && // Check if infoArray has the 'field' property
                    infoArray.hasOwnProperty('channel_id') && // Check if infoArray has the 'channel_id' property
                    typeof infoArray.channel_id === 'string' && // Check if the value of the 'channel_id' property is a string
                    infoArray.hasOwnProperty('value') // Check if infoArray has the 'value' property
                ) {
                    socket.emit('update-channel-info', infoArray);
                } else {
                    console.log('Invalid infoArray format');
                }
            }

            function createTeachingInfo(settingsInfo) {

                // Lama Select

                teachingLamaSelect = document.querySelector("#teaching_lama");

                const teachingLamaOption = document.createElement('option');
                teachingLamaOption.value = '';
                teachingLamaOption.text = 'Select Lama';
                teachingLamaSelect.appendChild(teachingLamaOption);
                teachingLamaSelect.onchange = (event) => {
                    const curTeachingLama = event.target.value;
                    const infoArray = {
                        field: 'lama',
                        value: curTeachingLama
                    };
                    emitUpdateTeachingInfo(infoArray);
                };

                const settingTeachingLama = settingsInfo.teaching_info.lama;
                for (const [lamaCode, lamaName] of Object.entries(settingsInfo.lamas)) {
                    const option = document.createElement('option');
                    option.value = lamaCode;
                    option.text = lamaName;
                    if (lamaCode === settingTeachingLama) {
                        option.selected = true;
                    }
                    teachingLamaSelect.appendChild(option);
                }

                // Teaching Select

                teachingNameSelect = document.querySelector("#teaching_name");

                const teachingNameOption = document.createElement('option');
                teachingNameOption.value = '';
                teachingNameOption.text = 'Select Teaching';
                teachingNameSelect.appendChild(teachingNameOption);
                teachingNameSelect.onchange = (event) => {
                    const curTeachingName = event.target.value;
                    const infoArray = {
                        field: 'teaching',
                        value: curTeachingName
                    };
                    emitUpdateTeachingInfo(infoArray);
                };

                const settingTeachingName = settingsInfo.teaching_info.teaching;
                for (const [teachingCode, teachingName] of Object.entries(settingsInfo.teachings)) {
                    const option = document.createElement('option');
                    option.value = teachingCode;
                    option.text = teachingName;
                    if (teachingCode === settingTeachingName) {
                        option.selected = true;
                    }
                    teachingNameSelect.appendChild(option);
                }

                // Folder Select

                teachingCopyFolderSelect = document.querySelector("#teaching_copy_folder");

                const teachingCopyFolderSelectOption = document.createElement('option');
                teachingCopyFolderSelectOption.value = '';
                teachingCopyFolderSelectOption.text = 'Select Folder';
                teachingCopyFolderSelect.appendChild(teachingCopyFolderSelectOption);
                teachingCopyFolderSelect.onchange = (event) => {
                    const curTeachingCopyFolder = event.target.value;
                    const infoArray = {
                        field: 'copy_folder',
                        value: curTeachingCopyFolder
                    };
                    emitUpdateTeachingInfo(infoArray);
                };

                const settingCopyFolder = settingsInfo.teaching_info.copy_folder;
                for (const [copyFolderCode, teachingCopyFolder] of Object.entries(settingsInfo.copy_folders)) {
                    const option = document.createElement('option');
                    option.value = copyFolderCode;
                    option.text = teachingCopyFolder.name;
                    if (copyFolderCode === settingCopyFolder) {
                        option.selected = true;
                    }
                    teachingCopyFolderSelect.appendChild(option);
                }

            }

            function updateProfilesInfo(profiles,current_profile) {
                profileSelect = document.querySelector("#profile");

                const profileSelectOption = document.createElement('option');
                profileSelectOption.value = '';
                profileSelectOption.text = 'None';
                profileSelect.appendChild(profileSelectOption);

                for (const filename in profiles) {

                    const option = document.createElement('option');
                    option.value = filename;
                    option.text = profiles[filename];
                    if (current_profile === filename) {
                        option.selected = true;
                    }
                    profileSelect.appendChild(option);
                }
            }

            function createChannelsInfo(settingsInfo) {
                for (const channelId in settingsInfo.channels) {

                    const channel = settingsInfo.channels[channelId];
                    const statusItem = document.createElement('div');
                    statusItem.className = 'status-item';
                    statusItem.setAttribute('id', channelId);
                    statusContainer.appendChild(statusItem);

                    // Add status indicator column
                    const statusIndicatorContainer = document.createElement('div');
                    statusIndicatorContainer.className = 'status-indicator-container';
                    statusItem.appendChild(statusIndicatorContainer);
                    const statusIndicator = document.createElement('div');
                    statusIndicator.className = 'status-indicator';
                    statusIndicatorContainer.appendChild(statusIndicator);

                    // Add process name column
                    const processInfo = document.createElement('div');
                    processInfo.style.verticalAlign = 'middle';
                    processInfo.className = 'channel-name';
                    processInfo.textContent = channel.name;
                    statusItem.appendChild(processInfo);

                    // Add elapsed time column
                    const elapsedTimeDiv = document.createElement('div');
                    elapsedTimeDiv.className = 'elapsed-time';
                    statusItem.appendChild(elapsedTimeDiv);

                    // Add start/stop buttons column
                    const buttonsContainer = document.createElement('div');
                    buttonsContainer.className = 'buttons-container';
                    statusItem.appendChild(buttonsContainer);
                    const startButton = document.createElement('button');
                    startButton.textContent = 'Start';
                    startButton.onclick = () => {
                        startPM2(channelId);
                    };
                    const stopButton = document.createElement('button');
                    stopButton.textContent = 'Stop';
                    stopButton.onclick = () => {
                        stopPM2(channelId);
                    };
                    buttonsContainer.appendChild(startButton);
                    buttonsContainer.appendChild(stopButton);

                    // Add Channel Options block
                    const channelOptions = document.createElement('div');
                    channelOptions.className = 'channel-options';
                    statusItem.appendChild(channelOptions);

                    // Add language name column
                    const languageSelect = document.createElement('select');
                    languageSelect.className = 'language-select';
                    languageSelect.setAttribute('channel-id', channelId);

                    const option = document.createElement('option');
                    option.value = '';
                    option.text = 'Select Language';
                    languageSelect.appendChild(option);
                    languageSelect.onchange = (event) => {
                        const curLanguage = event.target.value;
                        const infoArray = {
                            field: 'language',
                            channel_id: channelId,
                            value: curLanguage
                        };
                        emitUpdateChannelInfo(infoArray);
                    };

                    // Loop through the object keys and values and create options
                    const channelLanguage = settingsInfo.channels[channelId].language;
                    for (const [code, language] of Object.entries(settingsInfo.languages)) {
                        const option = document.createElement('option');
                        option.value = code;
                        option.text = language.name;
                        if (code === channelLanguage) {
                            option.selected = true;
                        }
                        languageSelect.appendChild(option);
                    }

                    const languageLabel = document.createElement('label');
                    languageLabel.textContent = "Language";
                    const languageBlock = document.createElement('div');
                    languageBlock.className = 'language-block';

                    languageBlock.appendChild(languageLabel);
                    languageBlock.appendChild(languageSelect);
                    channelOptions.appendChild(languageBlock);

                    // Add input column
                    const deviceSelect = document.createElement('select');
                    deviceSelect.className = 'device-select';
                    deviceSelect.setAttribute('channel-id', channelId);

                    const deviceOption = document.createElement('option');
                    deviceOption.value = '';
                    deviceOption.text = 'Select Device';
                    deviceSelect.appendChild(deviceOption);
                    deviceSelect.onchange = (event) => {
                        const curDevice = event.target.value;
                        const infoArray = {
                            field: 'device',
                            channel_id: channelId,
                            value: curDevice
                        };
                        emitUpdateChannelInfo(infoArray);
                    };

                    // Loop through the object keys and values and create options
                    const channelDevice = settingsInfo.channels[channelId].device;
                    for (const [code, device] of Object.entries(settingsInfo.avfoundationDevices)) {
                        const option = document.createElement('option');
                        option.value = code;
                        option.text = device.name;
                        if (code === channelDevice) {
                            option.selected = true;
                        }
                        deviceSelect.appendChild(option);
                    }

                    const deviceLabel = document.createElement('label');
                    deviceLabel.textContent = "Device";
                    const deviceBlock = document.createElement('div');
                    deviceBlock.className = 'device-block';

                    deviceBlock.appendChild(deviceLabel);
                    deviceBlock.appendChild(deviceSelect);
                    channelOptions.appendChild(deviceBlock);

                    // Create copy checkbox

                    const cpServerCheckbox = document.createElement('input');
                    cpServerCheckbox.type = 'checkbox';
                    cpServerCheckbox.id = 'copy_to_server';

                    const cpServerLabel = document.createElement('label');
                    cpServerLabel.htmlFor = 'copy_to_server';
                    cpServerLabel.appendChild(document.createTextNode('Copy to Server'));

                    const cpServerBlock = document.createElement('div');
                    cpServerBlock.className = 'cp-server-block';

                    cpServerBlock.appendChild(cpServerCheckbox);
                    cpServerBlock.appendChild(cpServerLabel);
                    channelOptions.appendChild(cpServerBlock);


                    // Listen for status updates from server
                    socket.on(`${channelId}-status`, (isRunning) => {
                        if (isRunning) {
                            statusIndicator.classList.add('greenIndicator');
                            statusIndicator.classList.remove('redIndicator');
                            startButton.disabled = true;
                            stopButton.disabled = false;
                        } else {
                            statusIndicator.classList.add('redIndicator');
                            statusIndicator.classList.remove('greenIndicator');
                            startButton.disabled = false;
                            stopButton.disabled = true;
                            elapsedTimeDiv.textContent = '';
                        }
                    });

                    // Listen for elapsed time updates from server
                    socket.on(`${channelId}-time`, (elapsedTime) => {
                        if (elapsedTime) {
                            elapsedTimeDiv.innerHTML = elapsedTime;
                        }
                    });

                }

            }

            // TODO : finish this : get elapsedTime, green or red status and other things like dropdown language etc
            function updatesettingsInfo(settingsInfo) {
                for (const channelId in settingsInfo.channels) {
                    const channel = settingsInfo[channelId];
                    channelStatusItem = document.querySelector("#" + channelId);
                    channelStatusItem.querySelector('.channel-name').textContent = channel.name;

                }
            }


            const statusContainer = document.getElementById('status-container');
            const socket = io();

            socket.on('profiles-update', (profiles,current_profile) => {
                updateProfilesInfo(profiles,current_profile);
            });

            // Add an event listener for the 'return-value' event on the socket
            socket.on('settings-info-value', (settingsInfo) => {

                createTeachingInfo(settingsInfo);

                createChannelsInfo(settingsInfo);

                document.querySelector("#start-all-button").onclick = function () { startAll(settingsInfo); };
                // alert(document.querySelector("#start-all-button").onclick);
                document.querySelector("#restart-all-button").onclick = function () { restartAll(settingsInfo); };
                document.querySelector("#stop-all-button").onclick = function () { stopAll(settingsInfo); };

            });

            socket.on('profile-new-result', (profileNewResult) => {
                const profilePopupResult = document.querySelector("#profile_popup_result");
                profilePopupResult.textContent = profileNewResult;
                profilePopupResult.style.display = "block";

            });

            // Emit a 'settings-info-value' event to the server to trigger the function call
            socket.emit('settings-info');
            // Update profiles
            socket.emit('get-profiles');

        </script>

</body>
</div>

</html>