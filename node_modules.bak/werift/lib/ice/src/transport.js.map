{"version":3,"file":"transport.js","sourceRoot":"","sources":["../../../../ice/src/transport.ts"],"names":[],"mappings":"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","sourcesContent":["import debug from \"debug\";\nimport { createSocket, Socket, SocketType } from \"dgram\";\n\nimport {\n  findPort,\n  interfaceAddress,\n  InterfaceAddresses,\n} from \"../../common/src\";\nimport { Address } from \"./types/model\";\nimport { normalizeFamilyNodeV18 } from \"./utils\";\n\nconst log = debug(\"werift-ice:packages/ice/src/transport.ts\");\n\nexport class UdpTransport implements Transport {\n  private socket: Socket;\n  onData: (data: Buffer, addr: Address) => void = () => {};\n\n  constructor(\n    private type: SocketType,\n    private portRange?: [number, number],\n    private interfaceAddresses?: InterfaceAddresses\n  ) {\n    this.socket = createSocket(this.type);\n    this.socket.on(\"message\", (data, info) => {\n      if (normalizeFamilyNodeV18(info.family) === 6) {\n        [info.address] = info.address.split(\"%\"); // example fe80::1d3a:8751:4ffd:eb80%wlp82s0\n      }\n      try {\n        this.onData(data, [info.address, info.port]);\n      } catch (error) {\n        log(\"onData error\", error);\n      }\n    });\n  }\n\n  static async init(\n    type: SocketType,\n    portRange?: [number, number],\n    interfaceAddresses?: InterfaceAddresses\n  ) {\n    const transport = new UdpTransport(type, portRange, interfaceAddresses);\n    await transport.init();\n    return transport;\n  }\n\n  private async init() {\n    const address = interfaceAddress(this.type, this.interfaceAddresses);\n    if (this.portRange) {\n      const port = await findPort(\n        this.portRange[0],\n        this.portRange[1],\n        this.type,\n        this.interfaceAddresses\n      );\n      this.socket.bind({ port, address });\n    } else {\n      this.socket.bind({ address });\n    }\n    await new Promise((r) => this.socket.once(\"listening\", r));\n  }\n\n  send = (data: Buffer, addr: Address) =>\n    new Promise<void>((r, f) => {\n      this.socket.send(data, addr[1], addr[0], (error) => {\n        if (error) {\n          log(\"send error\", addr, data);\n          f(error);\n        } else {\n          r();\n        }\n      });\n    });\n\n  address() {\n    return this.socket.address();\n  }\n\n  close = () =>\n    new Promise<void>((r) => {\n      this.socket.once(\"close\", r);\n      try {\n        this.socket.close();\n      } catch (error) {\n        r();\n      }\n    });\n}\n\nexport interface Transport {\n  onData: (data: Buffer, addr: Address) => void;\n  send: (data: Buffer, addr: Address) => Promise<void>;\n}\n"]}