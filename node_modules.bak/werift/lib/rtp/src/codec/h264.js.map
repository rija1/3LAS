{"version":3,"file":"h264.js","sourceRoot":"","sources":["../../../../../rtp/src/codec/h264.ts"],"names":[],"mappings":"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","sourcesContent":["// RFC 6184 - RTP Payload Format for H.264 Video\n\nimport { getBit } from \"../../../common/src\";\nimport { RtpHeader } from \"../rtp/rtp\";\nimport { DePacketizerBase } from \"./base\";\n\n// FU indicator octet\n// +---------------+\n// |0|1|2|3|4|5|6|7|\n// +-+-+-+-+-+-+-+-+\n// |F|NRI|  Type   |\n// +---------------+\n\n// FU header\n// +---------------+\n// |0|1|2|3|4|5|6|7|\n// +-+-+-+-+-+-+-+-+\n// |S|E|R|  Type   |\n// +---------------+\n\nexport class H264RtpPayload implements DePacketizerBase {\n  /**forbidden_zero_bit */\n  f!: number;\n  /**nal_ref_idc */\n  nri!: number;\n  /**nal_unit_types */\n  nalUnitType!: number;\n  /**start of a fragmented NAL unit */\n  s!: number;\n  /**end of a fragmented NAL unit */\n  e!: number;\n  r!: number;\n  nalUnitPayloadType!: number;\n  payload!: Buffer;\n\n  static deSerialize(buf: Buffer) {\n    const h264 = new H264RtpPayload();\n\n    let offset = 0;\n\n    h264.f = getBit(buf[offset], 0);\n    h264.nri = getBit(buf[offset], 1, 2);\n    h264.nalUnitType = getBit(buf[offset], 3, 5);\n    offset++;\n\n    h264.s = getBit(buf[offset], 0);\n    h264.e = getBit(buf[offset], 1);\n    h264.r = getBit(buf[offset], 2);\n    h264.nalUnitPayloadType = getBit(buf[offset], 3, 5);\n    offset++;\n\n    // デフォルトでは packetization-mode=0\n    // packetization-mode=0だとSingle NAL Unit Packetしか来ない\n    // https://datatracker.ietf.org/doc/html/rfc6184#section-6.2\n\n    // Single NAL Unit Packet\n    if (0 < h264.nalUnitType && h264.nalUnitType < 24) {\n      h264.payload = this.packaging(buf);\n    }\n    // Single-time aggregation packet\n    else if (h264.nalUnitType === NalUnitType.stap_a) {\n      let offset = stap_aHeaderSize;\n      let result: Buffer = Buffer.alloc(0);\n      while (offset < buf.length) {\n        const naluSize = buf.readUInt16BE(offset);\n        offset += stap_aNALULengthSize;\n\n        result = Buffer.concat([\n          result,\n          this.packaging(buf.subarray(offset, offset + naluSize)),\n        ]);\n        offset += naluSize;\n      }\n      h264.payload = result;\n    }\n\n    return h264;\n  }\n\n  private static packaging(buf: Buffer) {\n    return Buffer.concat([annex_bNALUStartCode, buf]);\n  }\n\n  static isDetectedFinalPacketInSequence(header: RtpHeader) {\n    return header.marker;\n  }\n\n  get isKeyframe() {\n    return this.nalUnitType === NalUnitType.idrSlice;\n  }\n\n  get isPartitionHead() {\n    if (\n      this.nalUnitType === NalUnitType.fu_a ||\n      this.nalUnitType === NalUnitType.fu_b\n    ) {\n      return this.s !== 0;\n    }\n\n    return true;\n  }\n}\n\nexport const NalUnitType = {\n  idrSlice: 5,\n  stap_a: 24,\n  stap_b: 25,\n  mtap16: 26,\n  mtap24: 27,\n  fu_a: 28,\n  fu_b: 29,\n} as const;\n\nconst annex_bNALUStartCode = Buffer.from([0x00, 0x00, 0x00, 0x01]);\n\nconst stap_aHeaderSize = 1;\nconst stap_aNALULengthSize = 2;\n"]}