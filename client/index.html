<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-title" content="3LAS (Low Latency Live Audio Streaming)">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">

    <title>3LAS (Low Latency Live Audio Streaming)</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="script/util/3las.helpers.js"></script>
    <script src="script/util/3las.logging.js"></script>

    <link rel="stylesheet" href="style/main.css">
    <link rel="stylesheet" href="style/log_window.css">
    <link rel="stylesheet" href="style/player_controls.css">

    <script src="script/fallback/3las.liveaudioplayer.js"></script>
    <script src="script/fallback/3las.formatreader.js"></script>
    <script src="script/fallback/formats/3las.formatreader.mpeg.js"></script>
    <script src="script/fallback/formats/3las.formatreader.wav.js"></script>
    <script src="script/util/3las.websocketclient.js"></script>
    <script src="script/fallback/3las.fallback.js"></script>
    <script src="script/3las.webrtc.js"></script>
    <script src="script/3las.js"></script>
    <script src="script/main.js"></script>
    <script>
        const socket = io();
        var RtcConfig = {};
        var AudioTagId = "audioTag";

        function updateTeachingInfo(settingsInfo) {
            const teachingLamaDiv = document.querySelector('#teachingLama');
            const teachingNameDiv = document.querySelector('#teachingName');
            const lamaCode = settingsInfo.teaching_info.lama;
            const teachingCode = settingsInfo.teaching_info.teaching;

            // teachingLamaDiv.textContent = settingsInfo.teachings["dsdsdd"];
            teachingNameDiv.textContent = settingsInfo.lamas[lamaCode];
        }

        function updateChannelsInfo(settingsInfo) {

            for (const channelId in settingsInfo.channels) {
                const languageCode = settingsInfo.channels[channelId].language
                const languageName = settingsInfo.languages[languageCode].name;

                const channelLangDiv = document.querySelector("#" + channelId + " .channel_lang");

                if (channelLangDiv.innerHTML != languageName) {
                    channelLangDiv.innerHTML = languageName;
                }
            }

        }

        function createChannelsBlocks(settingsInfo) {
            for (const channelId in settingsInfo.channels) {

                const channelsDiv = document.querySelector("#channels");
                const channel = settingsInfo.channels[channelId];
                const channelButton = document.createElement('div');

                let languageName = "";
                if (settingsInfo.channels[channelId].language != "") {
                    languageName = settingsInfo.languages[settingsInfo.channels[channelId].language].name;
                }
                
                // Hide some channels
                if ((channelId=='channel_1') || (channelId=='channel_3') || (channelId=='channel_4')) {
                    // channelButton.style.display = 'none';
                }

                channelButton.className = 'channel_button';
                channelButton.id = channelId;
                channelButton.innerHTML = '<div class="channel_name">' + settingsInfo.channels[channelId].name + '</div>';
                channelButton.insertAdjacentHTML('beforeend', '<div class="channel_lang">' + languageName + '</div>');
                channelButton.onclick = function () {
                    Init(settingsInfo.channels[channelId]);
                    try {
                        Stream.Start();
                    }
                    catch (_ex) {
                    }
                    //    window.addEventListener('load', function(_ev) { Init(_ev, settingsInfo.channels[channelId]) }, false);
                };

                channelsDiv.appendChild(channelButton);
            }
            document.querySelector("#channel1").style.display = 'none';
            document.querySelector("#channel3").style.display = 'none';
            document.querySelector("#channel4").style.display = 'none';
        }

        // Add an event listener for the 'return-value' event on the socket
        socket.on('update-channels-info', (channelsInfo) => {
            updateChannelsInfo(channelsInfo);
        });

        // Add an event listener for the 'return-value' event on the socket
        socket.on('settings-info-value', (settingsInfo) => {
            updateTeachingInfo(settingsInfo);
            createChannelsBlocks(settingsInfo);
        });

        // Emit a 'settings-info-value' event to the server to trigger the function call
        socket.emit('settings-info');

        // Handle comment submit
        window.onload = function () {

            // const submitCommentButton = document.querySelector("#submit-comment");
            // const commentTextArea = document.querySelector("#comment");

            // submitCommentButton.onclick = function () {
            //     const comment = commentTextArea.value;
            //     socket.emit("submit-comment", comment);
            //     commentTextArea.value = "";
            // };

            // TODO Finish that!
            // socket.on('submit-comment-return', (message) => {
            //     alert(message);
            // });

        };
        // Bind init to page load see code in main.ts/main.js
        // window.addEventListener('load', Init, false);

        // window.addEventListener('load', function(_ev) { Init(_ev, "") }, false);
        // window.addEventListener('load', function(_ev) { Init(_ev, "audioTag2") }, false);

        document.ontouchmove = function (e) {
            e.preventDefault();
        }

        function hideChromeBanner() {
            document.getElementById("chromesuggestion").style.display = "none";
        }
    </script>
</head>

<body>
    <div class="container">
        <div class="topTitleCtn">
            <!-- <span class="logowheel">☸</span> -->
            <img class="logomarpa" src="style/marpa-live-high-resolution-color-logo.png" />
            <!-- <div class="topTitle">Marpa Live</div> -->
            <!-- <div class="topTitle">Translation Services</div> -->
        </div>

        <div class="content">

            <div class="teachingInfo">
                <div id="teachingLama"></div>
                <div id="teachingName"></div>
            </div>

            <div id="channels"></div>

            <div id="currentChannel"></div>
            <audio id="audioTag"></audio>
            <!-- <audio id="audioTag2"></audio> -->
            <div id="viewcontainer">
                <div id="audioplayer">
                    <div id="playbuttonoverlay">
                        <div id="playbutton"></div>
                    </div>
                    <div id="activityindicator">
                        <div id="redlighton"></div>
                        <div id="redlightoff"></div>
                    </div>
                    <div id="controlbar">
                        <div id="mutebutton"></div>
                        <div id="unmutebutton"></div>
                    </div>
                    <div id="volumebar">
                        <div id="totalvolume"></div>
                        <div id="currentvolume"></div>
                        <div id="volumeknob"></div>
                    </div>
                </div>
                <p id="logwindowbutton">Show/Hide event log</p>
                <ul id="logwindow"></ul>
            </div>
            <div id="lightbutton" style="display: none;"></div>
            <noscript>
                <div class="errormessage">
                    <p>JavaScript not supported!</p>
                    <p>Please enable JavaScript.</p>
                    <p>Or try another browser.</p>
                </div>
            </noscript>
            <div id="chromesuggestion">
                <p>We recommend viewing this page with Google Chrome.</p>
                <p><a href="http://itunes.apple.com/app/id535886823">Download Google Chrome</a></p>
                <p><span onclick="hideChromeBanner();">Ignore and continue</span></p>
            </div>
            <div class="errormessage" id="typesunsupported" style="display: none;">
                <p>None of the used datatypes are supported by your browser!</p>
                <p>Please try another browser.</p>
            </div>
            <div class="errormessage" id="socketsunsupported" style="display: none;">
                <p>Websockets are not supported by your browser!</p>
                <p>Please try another browser.</p>
            </div>
            <div class="errormessage" id="webaudiounsupported" style="display: none;">
                <p>The WebAudio API is not supported by your browser!</p>
                <p>Please try another browser.</p>
            </div>
            <div id="lightoff" style="display: none;"></div>

            <!-- <div class="disclaimer">Please note that this audio streaming page is a work in progress. If you encounter
                any
                issues or have suggestions, please let me know in the box below and press send. Thank you.</div>
            <textarea id="comment"></textarea>
            <button id="submit-comment">Send</button> -->
        </div>
    </div>
</body>

</html>